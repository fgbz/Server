<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="phalaenopsis.fgbz.dao.LawstandardDao" >

    <select id="testCount" resultType="int">
        SELECT count(1) from m_bs_lawstandard
    </select>

    <!--查询法规标准类别 -->
    <select id="SelectLawstandardType" resultType="LawstandardType">
           SELECT
        t.ID,
        t.TYPENAME,
        t.PARENTID,
         t.itemlevel,
        t.itemlevelcode,
        t.LAWCOUNT,
        CASE
    WHEN (
        SELECT
            count(1)
        FROM
            m_bs_lawstandard_type link
        WHERE
            link.LAWSTYPEID = t.id) = 0 then 1 else 0 end as candelete
        FROM
            m_bs_lawstandardtype t order by t.itemlevel,t.itemlevelcode
    </select>

    <!--删除法规标准类别-->
    <delete id="DeleteLawstandardType" parameterType="LawstandardType">
        DELETE from m_bs_lawstandardtype where id = #{id}
    </delete>

    <!--获取最新的结构层级-->
    <select id="getLastItemLevelcode" parameterType="String" resultType="int">
        select IF(ISNULL(max(t.ITEMLEVELCODE)),0,max(t.ITEMLEVELCODE)+1) from m_bs_lawstandardtype t where t.PARENTID= #{id}
    </select>

    <!--处理上移和下移-->
    <update id="handTreeLevel" parameterType="LawstandardType">
        <if test="handletype == 'moveUp'.toString()">
            update m_bs_lawstandardtype t set t.ITEMLEVELCODE = (t.ITEMLEVELCODE+1) where t.PARENTID =#{parentid}  and t.ITEMLEVELCODE=(#{itemlevelcode}-1)
        </if>
        <if test="handletype == 'moveDown'.toString()">
            update m_bs_lawstandardtype t set t.ITEMLEVELCODE = (t.ITEMLEVELCODE-1) where t.PARENTID =#{parentid}  and t.ITEMLEVELCODE=(#{itemlevelcode}+1)
        </if>
        <if test="handletype == 'delete'.toString()">
            update m_bs_lawstandardtype t set t.ITEMLEVELCODE = (t.ITEMLEVELCODE-1) where t.PARENTID =#{parentid}  and t.ITEMLEVELCODE>#{itemlevelcode}
        </if>
    </update>

    <!--新增或修改法规标准类别-->
    <insert id="AddOrUpdateLawstandardType" parameterType="LawstandardType">
        <selectKey keyProperty="count" resultType="int" order="BEFORE">
            select count(1) from m_bs_lawstandardtype t where t.ID=#{id}
        </selectKey>

        <if test="count==0">
            INSERT into m_bs_lawstandardtype  (ID,TYPENAME, PARENTID,INPUTUSERID,INPUTDATE,MODIFYDATE,itemlevel,itemlevelcode,LAWCOUNT )
            VALUES (#{id},#{typename},#{parentid},#{inputuserid,jdbcType=VARCHAR},now(),now(),#{itemlevel,jdbcType=INTEGER},#{itemlevelcode,jdbcType=INTEGER},0);
        </if>
        <if test="count==1">
            UPDATE  m_bs_lawstandardtype t  SET t.TYPENAME = #{typename,jdbcType=VARCHAR},t.MODIFYUSERID=#{modifyuserid,jdbcType=VARCHAR},t.MODIFYDATE = now(),t.itemlevelcode = #{itemlevelcode,jdbcType=INTEGER}
            where t.ID = #{id}
        </if>
    </insert>

    <select id="getChildNode" parameterType="String" resultType="LawstandardType">
        select t.id,t.TYPENAME,t.PARENTID, t.LAWCOUNT from m_bs_lawstandardtype t where t.PARENTID=#{id}
    </select>

    <!--获取父级法规标准类别-->
    <select id="getParentLawstandardTypeById" parameterType="String" resultType="LawstandardType">
SELECT
	m.ID,
	m.TYPENAME,
	m.PARENTID,
	m.LAWCOUNT
FROM
	m_bs_lawstandardtype m
WHERE
	m.ID = (
		SELECT
			t.PARENTID
		FROM
			m_bs_lawstandardtype t
		WHERE
			t.ID = #{id}
	)
    </select>

    <!--改变类别法规数量-->
    <update id="changeLawstandardCount" parameterType="map">
       UPDATE m_bs_lawstandardtype t
SET
    <if test="type == 'add'.toString()">
        t.LAWCOUNT =
        IF (
        ISNULL(t.LAWCOUNT),
        0,
        t.LAWCOUNT
        ) + 1
    </if>
    <if test="type == 'delete'.toString()">
            t.LAWCOUNT =
            IF (
            ISNULL(t.LAWCOUNT),
            0,
            t.LAWCOUNT
            ) - 1
    </if>

WHERE
	t.ID IN
        <foreach collection="TreeValue" item="item" open="(" close=")" separator=",">
        #{item.id}
        </foreach>

    </update>

    <!--查询法律标准列表-->
    <select id="getLawstandardList" parameterType="map" resultType="Lawstandard">
        select t.ID,t.`CODE`,t.CHINESENAME,t.APPROVESTATUS,sta.STATUSNAME,t.RELEASEDATE ,t.IMPDATE,n.TYPENAME,t.CLICKCOUNT , t.MEMO,
        t.SUMMARYINFO,t.ENGLISHNAME, t.KEYWORDS,t.IsBatch,t.INPUTDATE,
        t.USERREALNAME as inputusername, dep.PUBDEPNAME,
        case when (select count(1) from m_bs_lawstandard_approve app where app.LawstandardID = t.id)>0 then 1 else 0 end as isapprove
        from
        ( SELECT t1.*,ur.USERREALNAME from m_bs_lawstandard t1
        left join m_sa_user ur on ur.ID = t1.INPUTUSERID
        where t1.APPROVESTATUS <![CDATA[  != ]]> 4
        <include refid="queryLawstandard"></include>
        order by  ${Ordertype1}
        LIMIT #{startRow},#{endRow})
        t
        left join m_sa_lawstandardstatus sta on t.`STATUS` = sta.ID
        left join (select temp.sid,max(temp.PUBDEPID) as PUBDEPID from `m_bs_lawstandard_pubdep` temp group by temp.sid) pub on t.id = pub.SID
        left join m_sa_publishdep dep on dep.ID = pub.PUBDEPID
        left join m_bs_lawstandard_type m on m.SID = t.id
        left join m_bs_lawstandardtype n on n.id = m.LAWSTYPEID
        order by  ${Ordertype}
    </select>

    <!-- 查询列表的总数 -->
    <select id="getLawstandardListCount" resultType="int">
        select count(1) from m_bs_lawstandard t1
        left join m_sa_user ur on ur.ID = t1.INPUTUSERID
        where t1.APPROVESTATUS <![CDATA[  != ]]> 4
        <include refid="queryLawstandard"></include>
    </select>


    <select id="getUptodateLawstandardList" parameterType="map" resultType="Lawstandard">
        SELECT t.ID,t.`CODE`,t.CHINESENAME,t.APPROVESTATUS,dep.PUBDEPNAME,t.CLICKCOUNT,t.RELEASEDATE ,t.IMPDATE,ur.USERREALNAME as inputusername,t.INPUTDATE from

        ( SELECT  *from m_bs_lawstandard m where 1=1
        <if test="TreeValue !=null and TreeValue!=''" >
            and m.id in (select lt.SID from m_bs_lawstandard_type lt where lt.LAWSTYPEID in
            <foreach collection="TreeValue" item="item" open="(" close=")" separator=",">
                #{item.id}
            </foreach>
            )
        </if>
        <if test="ApproveStatus != null and ApproveStatus != ''">
            and m.APPROVESTATUS = #{ApproveStatus}
        </if>
        order by m.MODIFYDATE DESC
        LIMIT #{startRow},#{endRow}
        )t
        left join (select temp.sid,max(temp.PUBDEPID) as PUBDEPID from `m_bs_lawstandard_pubdep` temp group by temp.sid) pub on t.id = pub.SID
        left join m_sa_publishdep dep on dep.ID = pub.PUBDEPID
        left join m_sa_user ur on ur.ID = t.INPUTUSERID


    </select>

    <!--获取引用和替代关系列表-->
    <select id="getReplaceLawstandardList" parameterType="map" resultType="Lawstandard">
SELECT
	t.`CODE`,
	t.CHINESENAME,
	t.ID,
	t.APPROVESTATUS,
        t.inputuserid,
CASE

	WHEN (
	( SELECT count( 1 ) FROM m_bs_lsrelatedrelation relate WHERE relate.RelatedID = t.id ) + ( SELECT count( 1 ) FROM m_bs_lsreplacerelation replacelaw WHERE replacelaw.SID = t.id )
	) > 0 THEN
		0 ELSE 1
	END AS canDelete
FROM
m_bs_lawstandard t
where t.APPROVESTATUS in ('3','4')
        <include refid="queryReplaceLawstandard"></include>
ORDER BY t.MODIFYDATE desc
        LIMIT #{startRow},#{endRow}
    </select>

    <sql id="queryReplaceLawstandard">
        <if test="Number != null and Number != ''">
            and instr(t.CHECKCODE,#{Number})> 0
        </if>
        <if test="Title != null and Title != ''">
            and instr(t.CHINESENAME,#{Title})> 0
        </if>
        <if test="ApproveStatus != null and ApproveStatus != ''">
            and t.APPROVESTATUS = #{ApproveStatus}
        </if>
        <!--引用文件不查自己-->
        <if test="ReplaceOrRefenceid != null and ReplaceOrRefenceid != ''">
            and t.id <![CDATA[  != ]]> #{ReplaceOrRefenceid}
        </if>
    </sql>

    <!--获取引用和替代关系列表总数-->
    <select id="getReplaceLawstandardCount" parameterType="map" resultType="int">
        SELECT
      count(1)
        FROM
        m_bs_lawstandard t
        where t.APPROVESTATUS in ('3','4')
        <include refid="queryReplaceLawstandard"></include>
    </select>

    <sql id="querySolr">
         (
            instr(
            t1. CODE,
            #{item}
            ) > 0
            OR instr(
            t1.CHINESENAME,
            #{item}
            ) > 0
            OR instr(
            t1.ENGLISHNAME,
            #{item}
            ) > 0
            OR instr(
            t1.KEYWORDS,
            #{item}
            ) > 0
            OR instr(
            t1.MEMO,
            #{item}
            ) > 0
            OR instr(
            t1.SUMMARYINFO,
            #{item}
            ) > 0
            OR instr(
            (
            SELECT
            group_concat(file.Content)
            FROM
            m_sa_fileinfo file
            WHERE
            file.REFID = t1.id
            ),
            #{item}
            ) > 0
            OR instr(
            (
            SELECT
            stu.STATUSNAME
            FROM
            m_sa_lawstandardstatus stu
            WHERE
            stu.id = t1. STATUS
            ),
            #{item}
            ) > 0
            OR instr(
            (
            SELECT
            dep.PUBDEPNAME
            FROM
            m_sa_publishdep dep
            LEFT JOIN m_bs_lawstandard_pubdep pub ON dep.ID = pub.PUBDEPID
            WHERE
            pub.sid = t1.id
            ),
            #{item}
            ) > 0

            )
    </sql>
    <!--获取全文检索-->
    <select id="getSolrList" parameterType="map" resultType="Lawstandard">
		SELECT
        t1.CHINESENAME,
        t1.ENGLISHNAME,
        t1.SUMMARYINFO,
        t1.`CODE`,
        t1.id,
        t1.CLICKCOUNT,
        t1.KEYWORDS
		FROM
        m_bs_solr solr
        left join m_bs_lawstandard t1 on solr.lawstandardid = t1.id where
        (
        <foreach collection="Solr" index="index" item="item" open="" close="" separator="or">
            INSTR(solr.SOLRTEXT,#{item})>0
        </foreach>
        )
        <include refid="queryLawstandard"></include>
        LIMIT #{startRow},#{endRow}
    </select>

    <!--获取全文检索-->
    <select id="getSolrListCount" parameterType="map" resultType="int">
        SELECT
      count(1)
        FROM
        m_bs_solr solr
        left join m_bs_lawstandard t1 on solr.lawstandardid = t1.id where
        (
        <foreach collection="Solr" index="index" item="item" open="" close="" separator="or">
            INSTR(solr.SOLRTEXT,#{item})>0
        </foreach>
        )
        <include refid="queryLawstandard"></include>
    </select>

    <sql id="queryLawstandard">
        <if test="Number != null and Number != ''">
            and instr(t1.CHECKCODE,#{Number})> 0
        </if>
        <if test="Title != null and Title != ''">
            and instr(t1.CHINESENAME,#{Title})> 0
        </if>
        <if test="FiledTimeStart != null and FiledTimeStart != ''">
            and Date(t1.RELEASEDATE) <![CDATA[  >=  ]]> #{FiledTimeStart}
        </if>
        <if test="FiledTimeEnd != null and FiledTimeEnd != ''">
            and Date(t1.RELEASEDATE) <![CDATA[  <=  ]]> #{FiledTimeEnd}
        </if>
        <if test="State != null and State != ''">
            and t1.`STATUS` = #{State}
        </if>
        <if test="organization != null and organization != ''">
            and  #{organization} in	(SELECT n.PUBDEPID from m_bs_lawstandard_pubdep n where n.sid =t1.ID)
        </if>
        <if test="MaterialTmeStart != null and MaterialTmeStart != ''">
            and Date(t1.IMPDATE) <![CDATA[  >=  ]]> #{MaterialTmeStart}
        </if>
        <if test="MaterialTmeEnd != null and MaterialTmeEnd != ''">
            and Date(t1.IMPDATE) <![CDATA[  <=  ]]> #{MaterialTmeEnd}
        </if>
        <if test="TreeValue !=null and TreeValue!=''" >
            and t1.id in (select lt.SID from m_bs_lawstandard_type lt where lt.LAWSTYPEID in
            <foreach collection="TreeValue" item="item" open="(" close=")" separator=",">
                #{item.id}
            </foreach>
            )
        </if>

        <if test="EnglishTitle != null and EnglishTitle != ''">
            and instr(t1.ENGLISHNAME,#{EnglishTitle})> 0
        </if>

        <if test="KeyWordsSingle != null and KeyWordsSingle != ''">
            and instr(t1.KEYWORDS,#{KeyWordsSingle})> 0
        </if>

        <if test="Summaryinfo != null and Summaryinfo != ''">
            and instr(t1.SUMMARYINFO,#{Summaryinfo})> 0
        </if>

        <!--全文检索-->
        <!--<if test="Solr != null and Solr != ''">-->
            <!--and (-->
            <!--<foreach collection="Solr" index="index" item="item" open="" close="" separator="or">-->
                  <!--instr((SELECT solr.solrtext from solrview solr where solr.id=t1.id),#{item} )>0-->
            <!--</foreach>-->
            <!--)-->
        <!--</if>-->

        <!--模糊匹配多个关键字-->
        <if test="KeyWords != null and KeyWords != ''">
            and (instr(t1.CODE,#{KeyWords})> 0 or instr(t1.CHINESENAME,#{KeyWords})> 0 or instr(t1.ENGLISHNAME,#{KeyWords})> 0
             or instr(t1.KEYWORDS,#{KeyWords})> 0 or instr(t1.MEMO,#{KeyWords})> 0 or instr(t1.SUMMARYINFO,#{KeyWords})> 0 )
        </if>
        <if test="ApproveStatus != null and ApproveStatus != ''">
            and t1.APPROVESTATUS = #{ApproveStatus}
        </if>

        <!--引用文件不查自己-->
        <if test="ReplaceOrRefenceid != null and ReplaceOrRefenceid != ''">
            and t1.id <![CDATA[  != ]]> #{ReplaceOrRefenceid}
        </if>
        <!--是否批量导入-->
        <if test="IsBatch != null and IsBatch != '' and IsBatch == 1 ">
        and t1.IsBatch = 1
       </if>
        <if test="IsBatch != null and IsBatch != '' and IsBatch == 0 ">
            and t1.IsBatch is NULL
        </if>
        <!--不能审核自己-->
        <if test="Userid != null and Userid != '' ">
            and t1.INPUTUSERID  <![CDATA[  != ]]>  #{Userid}
        </if>
        <!--草稿和审核状态只能自己看见-->
        <if test="LawInputuserid != null and LawInputuserid !='' ">
            and (t1.INPUTUSERID = #{LawInputuserid}  or (t1.APPROVESTATUS =3 and ur.ORGID in
            <foreach collection="OrgList" item="item" open="(" close=")" separator=",">
                #{item.id}
            </foreach>
            ))
        </if>
        <if test="selectInputUser != null and selectInputUser !='' ">
            and t1.INPUTUSERID = #{selectInputUser} and t1.APPROVESTATUS =3
        </if>

        <if test="Duty != null and Duty !='' ">
            and t1.INPUTUSERID = #{Duty}
        </if>

        <if test="ApproveOrg != null and ApproveOrg != ''">
            and  ur.ORGID in
            <foreach collection="ApproveOrg" item="item" open="(" close=")" separator=",">
                #{item.id}
            </foreach>
        </if>
    </sql>

    <delete id="deleteLawstandardById" parameterType="String">
        DELETE from m_bs_lawstandard WHERE  ID = #{id}
    </delete>

    <!--判断法规编号是否重复-->
    <select id="checklawCode" parameterType="Lawstandard" resultType="int">
        select count(1) from m_bs_lawstandard t where t.CHECKCODE = #{checkcode}
        and t.id <![CDATA[  != ]]> #{id} and t.APPROVESTATUS <![CDATA[  != ]]> 4
    </select>

    <select id="checklawTempCode" parameterType="Lawstandard" resultType="int">
        select count(1) from m_bs_lawstandard t where t.CHECKCODE = #{checkcode}
        and t.id <![CDATA[  != ]]> #{id}
    </select>

    <!--获取发布部门-->
    <select id="getPublishDep" resultType="FgbzDictory">
        SELECT t.ID,t.PUBDEPNAME as name  from m_sa_publishdep t
    </select>

    <!--获取法规状态-->
    <select id="getLawstandardState" resultType="FgbzDictory">
        SELECT t.id,t.STATUSNAME as name  from m_sa_lawstandardstatus t
    </select>

    <!--新增或编辑法规标准-->
    <insert id="SaveOrUpdateLawstandard" parameterType="Lawstandard">

        <selectKey keyProperty="count" resultType="int" order="BEFORE">
            select count(1) from m_bs_lawstandard t where t.ID=#{id}
        </selectKey>

        <if test="count == 0">
            insert into m_bs_lawstandard
            <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    ID,
                </if>
                <if test="code != null">
                    CODE,
                </if>
                <if test="chinesename != null">
                    CHINESENAME,
                </if>
                <if test="englishname != null">
                    ENGLISHNAME,
                </if>
                <if test="releasedate != null">
                    RELEASEDATE,
                </if>
                <if test="impdate != null">
                    IMPDATE,
                </if>
                <if test="keywords != null">
                    KEYWORDS,
                </if>
                <if test="isbatch != null">
                    ISBATCH,
                </if>
                <if test="inputuserid != null">
                    INPUTUSERID,
                </if>
                    INPUTDATE,
                <if test="modifyuserid != null">
                    MODIFYUSERID,
                </if>
                    MODIFYDATE,
                <if test="clickcount != null">
                    CLICKCOUNT,
                </if>
                <if test="downloadcount != null">
                    DOWNLOADCOUNT,
                </if>
                <if test="printcount != null">
                    PRINTCOUNT,
                </if>
                <if test="istop != null">
                    ISTOP,
                </if>
                <if test="memo != null">
                    MEMO,
                </if>
                <if test="summaryinfo != null">
                    SUMMARYINFO,
                </if>
                <if test="statusname != null">
                    STATUSNAME,
                </if>
                <if test="status != null">
                    STATUS,
                </if>
                <if test="approvestatus != null">
                    APPROVESTATUS,
                </if>
                <if test="checkcode != null">
                    checkcode,
                </if>
            </trim>
            <trim prefix="values (" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    #{id,jdbcType=VARCHAR},
                </if>
                <if test="code != null">
                    #{code,jdbcType=VARCHAR},
                </if>
                <if test="chinesename != null">
                    #{chinesename,jdbcType=VARCHAR},
                </if>
                <if test="englishname != null">
                    #{englishname,jdbcType=VARCHAR},
                </if>
                <if test="releasedate != null">
                    #{releasedate,jdbcType=TIMESTAMP},
                </if>
                <if test="impdate != null">
                    #{impdate,jdbcType=TIMESTAMP},
                </if>
                <if test="keywords != null">
                    #{keywords,jdbcType=VARCHAR},
                </if>
                <if test="isbatch != null">
                    #{isbatch,jdbcType=INTEGER},
                </if>
                <if test="inputuserid != null">
                    #{inputuserid,jdbcType=VARCHAR},
                </if>
                  now(),
                <if test="modifyuserid != null">
                    #{modifyuserid,jdbcType=VARCHAR},
                </if>

                   now(),

                <if test="clickcount != null">
                    #{clickcount,jdbcType=INTEGER},
                </if>
                <if test="downloadcount != null">
                    #{downloadcount,jdbcType=INTEGER},
                </if>
                <if test="printcount != null">
                    #{printcount,jdbcType=INTEGER},
                </if>
                <if test="istop != null">
                    #{istop,jdbcType=INTEGER},
                </if>
                <if test="memo != null">
                    #{memo,jdbcType=VARCHAR},
                </if>
                <if test="summaryinfo != null">
                    #{summaryinfo,jdbcType=VARCHAR},
                </if>
                <if test="statusname != null">
                    #{statusname,jdbcType=VARCHAR},
                </if>
                <if test="status != null">
                    #{status,jdbcType=VARCHAR},
                </if>
                <if test="approvestatus != null">
                    #{approvestatus,jdbcType=INTEGER},
                </if>
                <if test="checkcode != null">
                    #{checkcode,jdbcType=VARCHAR},
                </if>
            </trim>

        </if>
        <if test="count>0">
            update  m_bs_lawstandard set
            <trim prefix="" suffix="" suffixOverrides=",">

                <if test="code != null">
                    CODE = #{code,jdbcType=VARCHAR},
                </if>
                <if test="chinesename != null">
                    CHINESENAME = #{chinesename,jdbcType=VARCHAR},
                </if>
                <if test="englishname != null">
                    ENGLISHNAME = #{englishname,jdbcType=VARCHAR},
                </if>
                <if test="releasedate != null">
                    RELEASEDATE =#{releasedate,jdbcType=TIMESTAMP},
                </if>
                <if test="impdate != null">
                    IMPDATE= #{impdate,jdbcType=TIMESTAMP},
                </if>
                <if test="keywords != null">
                    KEYWORDS=#{keywords,jdbcType=VARCHAR},
                </if>
                <if test="isbatch != null">
                    ISBATCH=   #{isbatch,jdbcType=INTEGER},
                </if>

                <if test="modifyuserid != null">
                    MODIFYUSERID= #{modifyuserid,jdbcType=VARCHAR},
                </if>
                    MODIFYDATE= now(),

                <if test="clickcount != null">
                    CLICKCOUNT= #{clickcount,jdbcType=INTEGER},
                </if>
                <if test="downloadcount != null">
                    DOWNLOADCOUNT= #{downloadcount,jdbcType=INTEGER},
                </if>
                <if test="printcount != null">
                    PRINTCOUNT= #{printcount,jdbcType=INTEGER},
                </if>
                <if test="memo != null">
                    MEMO= #{memo,jdbcType=VARCHAR},
                </if>
                <if test="summaryinfo != null">
                    SUMMARYINFO=#{summaryinfo,jdbcType=VARCHAR},
                </if>
                <if test="statusname != null">
                    STATUSNAME= #{statusname,jdbcType=VARCHAR},
                </if>
                <if test="status != null">
                    STATUS=#{status,jdbcType=VARCHAR},
                </if>
                <if test="approvestatus != null">
                    APPROVESTATUS= #{approvestatus,jdbcType=INTEGER},
                </if>
                <if test="checkcode != null">
                    checkcode= #{checkcode,jdbcType=VARCHAR},
                </if>
            </trim>
            where ID=#{id}


        </if>
    </insert>

    <!--获取法规标准-->
    <select id="getLawstandardById" parameterType="String" resultType="Lawstandard">
        SELECT
        t.ID,
        t.`CODE`,
        t.CHINESENAME,
        t.ENGLISHNAME,
        t.RELEASEDATE,
        t.IMPDATE,
        t.KEYWORDS,
        t.MEMO,
        t.SUMMARYINFO,
        t.`STATUS`,
        t.APPROVESTATUS ,
        t.CLICKCOUNT,
        t.istop,
        sta.STATUSNAME,
        dep.ID as organization,
        dep.PUBDEPNAME,
        n.TYPENAME,
        n.id as lawtype,
				ur.USERREALNAME as inputusername,
				org.ORGNAME as inputorgname,
				t.INPUTDATE,urmo.USERREALNAME as modifyusername,t.MODIFYDATE,
			case when (select count(1) from m_bs_lawstandard_favorite fav where fav.sid = t.id)>0
			then 1 ELSE 0 END  as iscollect
        FROM
        `m_bs_lawstandard` t
        left join m_sa_lawstandardstatus sta on t.`STATUS` = sta.ID
        left join m_bs_lawstandard_pubdep pub on t.id = pub.SID
        left join m_sa_publishdep dep on dep.ID = pub.PUBDEPID
        left join m_bs_lawstandard_type m on m.SID = t.id
        left join m_bs_lawstandardtype n on n.id = m.LAWSTYPEID
				left join m_sa_user ur on ur.ID = t.INPUTUSERID
				left join m_sa_user urmo on urmo.ID = t.MODIFYUSERID
				left join m_sa_organization org on org.ID = ur.ORGID
				where t.id=#{id} LIMIT 0,1

    </select>

    <!--更新附件与法规的关系-->
    <update id="SaveFileLink" parameterType="Lawstandard">
        update m_sa_fileinfo t set t.REFID = #{id} where t.id IN
        <foreach collection="fileids" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </update>

    <!--选择替代关系，更新状态-->
    <update id="updateRleplaceStaus" parameterType="String">
        UPDATE m_bs_lawstandard set STATUS=4 where id=#{id}
    </update>

    <!--获取引用关系-->
    <select id="getRefenceList" parameterType="String" resultType="Lawstandard">
        SELECT
        t.ID,
        t.`CODE`,
        t.CHINESENAME,
        t.ENGLISHNAME,
        t.RELEASEDATE,
        t.IMPDATE,
        t.KEYWORDS,
        t.MEMO,
        t.SUMMARYINFO,
        t.`STATUS`,
        t.APPROVESTATUS

        FROM
        m_bs_lsrelatedrelation re
        left join m_bs_lawstandard t on re.RelatedID = t.ID
        where re.SID =#{id}
        ORDER BY t.RELEASEDATE desc
    </select>

    <!--获取替代关系-->
    <select id="getReplaceList" parameterType="String" resultType="Lawstandard">
        SELECT
        t.ID,
        t.`CODE`,
        t.CHINESENAME,
        t.ENGLISHNAME,
        t.RELEASEDATE,
        t.IMPDATE,
        t.KEYWORDS,
        t.MEMO,
        t.SUMMARYINFO,
        t.`STATUS`,
        t.APPROVESTATUS ,
        sta.STATUSNAME,
        n.TYPENAME

        FROM
        m_bs_lsreplacerelation re
        left join m_bs_lawstandard t on ((re.PID = t.ID and  re.SID = #{id}) or (re.SID = t.ID and  re.PID = #{id}))
        left join m_sa_lawstandardstatus sta on sta.id= t.`STATUS`
        left join m_bs_lawstandard_type m on m.SID = t.id
        left join m_bs_lawstandardtype n on n.id = m.LAWSTYPEID
        where t.id is not null
        ORDER BY t.RELEASEDATE desc

    </select>

    <!--删除引用关系-->
    <delete id="deleteRefence" parameterType="String">
        delete from m_bs_lsrelatedrelation  where SID = #{id}
    </delete>

    <!--删除引用关系和被引用关系-->
    <delete id="deleteRefenceAll" parameterType="String">
        delete from m_bs_lsrelatedrelation  where (SID = #{id} or RelatedID = #{id})
    </delete>

    <!--删除替代关系-->
    <delete id="deleteReplace" parameterType="String">
        delete from m_bs_lsreplacerelation  where PID = #{id}
    </delete>

    <!--删除替代关系和被替代关系-->
    <delete id="deleteReplaceAll" parameterType="String">
        delete from m_bs_lsreplacerelation  where (PID = #{id} or SID = #{id})
    </delete>

    <!-- 插入引用关系 -->
    <insert id="addRefence" parameterType="RefenceOrReplace">
        insert  into m_bs_lsrelatedrelation (ID,SID,RelatedID) values
        (#{id,jdbcType=VARCHAR},#{sid,jdbcType=VARCHAR},#{relatedid,jdbcType=VARCHAR})
    </insert>

    <!-- 插入引用关系 -->
    <insert id="addReplace" parameterType="RefenceOrReplace" >
        insert  into m_bs_lsreplacerelation (ID,SID,PID) values
        (#{id,jdbcType=VARCHAR},#{sid,jdbcType=VARCHAR},#{relatedid,jdbcType=VARCHAR})
    </insert>

    <!--建立类别与法规文件关联-->
    <insert id="SaveOrUpdateLawAndType" parameterType="Lawstandard">
        <selectKey keyProperty="count" resultType="int" order="BEFORE">
            select count(1) from m_bs_lawstandard_type t where t.SID=#{id}
        </selectKey>

        <if test="count == 0">
            insert into m_bs_lawstandard_type  (ID,SID,LAWSTYPEID) VALUES
            (uuid(),#{id},#{lawtype,jdbcType=VARCHAR})
        </if>
        <if test="count>0" >
            UPDATE m_bs_lawstandard_type t set t.LAWSTYPEID = #{lawtype,jdbcType=VARCHAR}
            where t.sid = #{id}
        </if>

    </insert>

    <!--删除类别与法规文件关联-->
    <delete id="DeleteLawAndType" parameterType="String">
        delete from m_bs_lawstandard_type  where SID= #{id}
    </delete>

    <insert id="SaveOrUpdateLawAndPublish" parameterType="Lawstandard">
        <selectKey keyProperty="count" resultType="int" order="BEFORE">
            select count(1) from m_bs_lawstandard_pubdep t where t.SID=#{id}
        </selectKey>

        <if test="count == 0 and organization != null and organization != ''">
            insert into m_bs_lawstandard_pubdep  (ID,SID,PUBDEPID) VALUES
            (uuid(),#{id},#{organization,jdbcType=VARCHAR})
        </if>
        <if test="count>0 and organization != null and organization != ''" >
            UPDATE m_bs_lawstandard_pubdep t set t.PUBDEPID = #{organization,jdbcType=VARCHAR}
            where t.sid = #{id}
        </if>

    </insert>

    <delete id="deletePubByLaw" parameterType="String">
        delete from m_bs_lawstandard_pubdep where SID=#{id}
    </delete>

    <!--点击次数加一-->
    <update id="AddLawstandardCount" parameterType="Lawstandard">
        update m_bs_lawstandard t set t.CLICKCOUNT = #{clickcount}
        where t.id = #{id}
    </update>

    <!--置顶-->
    <update id="LawstandardIsTop" parameterType="Lawstandard">
        update m_bs_lawstandard t set t.istop = #{istop}
        where t.id = #{id}
    </update>

    <!--更新法规状态-->
    <update id="updateLawstandardStatus" parameterType="map">
        update m_bs_lawstandard t set t.APPROVESTATUS = #{status} , MODIFYDATE = now() where t.id = #{id}
    </update>

    <!--更新所有待审核的法规-->
    <update id="updateAllCheckingLawstandard">
        update m_bs_lawstandard t set t.APPROVESTATUS = 3 , MODIFYDATE = now() where t.APPROVESTATUS=2
    </update>

    <!--上传前十统计-->
    <select id="getUploadPeople" resultType="ChartInfo">
SELECT
	*
FROM
	(
SELECT
	MAX( us.USERREALNAME ) AS NAME,
	count( 1 ) AS COUNT
FROM
	 m_sa_fileinfo file
	LEFT JOIN m_sa_user us ON file.INPUTUSERID = us.ID
	where us.USERREALNAME is not null
GROUP BY
	file.INPUTUSERID
	) t
ORDER BY
	count DESC
	LIMIT 0,
	10
    </select>
    <!--上传部门统计-->
    <select id="getUploadOrgname" resultType="ChartInfo">
  SELECT
	*
FROM
	(
		SELECT
			MAX(org.ORGNAME) AS NAME,
			count(1) AS count
		FROM
			m_sa_fileinfo file
		LEFT JOIN m_sa_user us ON file.INPUTUSERID = us.ID
		LEFT JOIN m_sa_organization org ON us.ORGID = org.ID
		WHERE
			 org.id IS NOT NULL
		GROUP BY
			org.id
	) t
ORDER BY
	t.count DESC
LIMIT 0,
 10
    </select>
    <!--上传分类统计-->
    <select id="getUploadType" resultType="ChartInfo">
SELECT
	*
FROM
	(
		SELECT
			ty.TYPENAME AS NAME,
			count(1) as count
		FROM
			m_sa_fileinfo file
		LEFT JOIN m_bs_lawstandard_type link ON file.REFID = link.SID
		LEFT JOIN m_bs_lawstandardtype ty ON ty.ID = link.LAWSTYPEID
		WHERE
			link.SID IS NOT NULL
		GROUP BY
			link.LAWSTYPEID
	) t
ORDER BY
	t.count DESC
LIMIT 0,
 10

    </select>

    <!--获取首页类别导航-->
    <select id="getHomePageLawsType" resultType="LawstandardType">
        SELECT
	t.id,
	t.TYPENAME,
	t.PARENTID,
	t.LAWCOUNT
FROM
	`m_bs_lawstandardtype` t
WHERE
	t.PARENTID = ( SELECT m.ID FROM m_bs_lawstandardtype m WHERE m.PARENTID IS NULL )
    </select>

    <!--通过名字获取法规类别-->
    <select id="getLawTypeByName" parameterType="String" resultType="String">
          select t.id from m_bs_lawstandardtype t where  t.TYPENAME = #{name} LIMIT 0,1
    </select>

    <!--通过名称获取发布部门id-->
    <select id="getPubOrgnameByName" parameterType="String" resultType="String">
          select t.id from m_sa_publishdep t where  t.PUBDEPNAME = #{name} LIMIT 0,1
    </select>

    <!--获取状态id-->
    <select id="getStatusIdByName" parameterType="String" resultType="String">
          select t.id from m_sa_lawstandardstatus t where  t.STATUSNAME = #{name} LIMIT 0,1
    </select>

    <select id="getHomePageLawCount" parameterType="map" resultType="int">
        SELECT  count(1) from m_bs_lawstandard t where t.APPROVESTATUS = 3
        and  t.id in (select lt.SID from m_bs_lawstandard_type lt where lt.LAWSTYPEID in
        <foreach collection="TreeValue" item="item" open="(" close=")" separator=",">
            #{item.id}
        </foreach>
        )
    </select>

    <!--通过附件id获取法规-->
    <select id="getLawByFileId" parameterType="String" resultType="Lawstandard">
       SELECT
    t.id,
	t.`CODE`,
	t.CHINESENAME
FROM
	m_bs_lawstandard t
LEFT JOIN m_sa_fileinfo files ON t.ID = files.REFID
WHERE
	files.ID =#{id}
    </select>

    <!--获取所有的法规-->
    <select id="getAllLawstandard" resultType="Lawstandard">
        SELECT t.id,t.code from m_bs_lawstandard t
    </select>

    <update id="updateLawCheckCode" parameterType="Lawstandard">
        UPDATE m_bs_lawstandard t set t.CHECKCODE=#{checkcode} where t.id = #{id}
    </update>

    <!--删除索引-->
    <delete id="DeleteSolrTextById" parameterType="String">
        DELETE from m_bs_solr where LAWSTANDARDID = #{id}
    </delete>

    <!--更新索引-->
    <insert id="SaveSolrTextById" parameterType="String">
        INSERT INTO m_bs_solr (LAWSTANDARDID, SOLRTEXT) SELECT
	`m`.`id` AS LAWSTANDARDID,
	concat(
		`m`.`CODE`,
		';',
		`m`.`CHINESENAME`,
		';',
		`m`.`ENGLISHNAME`,
		';',
		`m`.`KEYWORDS`,
		';',
		`m`.`MEMO`,
		';',
		`m`.`SUMMARYINFO`,
		';',
		`m`.`STATUSNAME`,
		';',
		`m`.`PUBDEPNAME`,
		';',
		`m`.`TYPENAME`,
		';',

	IF (
		isnull(`m`.`filecontent`),
		'',
		`m`.`filecontent`
	)
	) AS SOLRTEXT
FROM
	(
		SELECT
			`t`.`ID` AS `id`,
			`t`.`CODE` AS `CODE`,
			`t`.`CHINESENAME` AS `CHINESENAME`,

		IF (
			isnull(`t`.`ENGLISHNAME`),
			'',
			`t`.`ENGLISHNAME`
		) AS `ENGLISHNAME`,

	IF (
		isnull(`t`.`KEYWORDS`),
		'',
		`t`.`KEYWORDS`
	) AS `KEYWORDS`,

IF (
	isnull(`t`.`MEMO`),
	'',
	`t`.`MEMO`
) AS `MEMO`,

IF (
	isnull(`t`.`SUMMARYINFO`),
	'',
	`t`.`SUMMARYINFO`
) AS `SUMMARYINFO`,

IF (
	isnull(`sta`.`STATUSNAME`),
	'',
	`sta`.`STATUSNAME`
) AS `STATUSNAME`,

IF (
	isnull(`dep`.`PUBDEPNAME`),
	'',
	`dep`.`PUBDEPNAME`
) AS `PUBDEPNAME`,
 `n`.`TYPENAME` AS `TYPENAME`,
 (
	SELECT
		group_concat(
			`file`.`CONTENT` SEPARATOR ','
		)
	FROM
		`m_sa_fileinfo` `file`
	WHERE
		`file`.`REFID` = #{id}
) AS `filecontent`
FROM
	`m_bs_lawstandard` `t`
LEFT JOIN `m_sa_lawstandardstatus` `sta` ON `t`.`STATUS` = `sta`.`ID`
LEFT JOIN (select temp.sid,max(temp.PUBDEPID) as PUBDEPID from `m_bs_lawstandard_pubdep` temp group by temp.sid) `pub` ON `t`.`ID` = `pub`.`SID`
LEFT JOIN `m_sa_publishdep` `dep` ON `dep`.`ID` = `pub`.`PUBDEPID`
LEFT JOIN m_bs_lawstandard_type `m` ON `m`.`SID` = `t`.`ID`
LEFT JOIN m_bs_lawstandardtype `n` ON `n`.`ID` = `m`.`LAWSTYPEID`
 	 WHERE `t`.`ID` = #{id}
	) `m`
    </insert>

    <!--通过法规状态获取所有的法规-->
    <select id="getLawsByStaus" parameterType="String" resultType="Lawstandard">
          SELECT t.ID from m_bs_lawstandard t where t.`STATUS`=#{id}
    </select>

    <!--通过发布部门获取所有的法规-->
    <select id="getLawsByPubdep" parameterType="String" resultType="Lawstandard">
SELECT
	law.id
FROM
	m_sa_publishdep pub
INNER JOIN m_bs_lawstandard_pubdep dep ON dep.PUBDEPID = pub.id
INNER JOIN m_bs_lawstandard law ON dep.SID = law.ID
where pub.id=#{id}
    </select>

    <!--通过类别获取所有的法规-->
    <select id="getLawsByLawType" parameterType="String" resultType="Lawstandard">
      SELECT
	law.ID
FROM
	m_bs_lawstandard_type lawtype
INNER JOIN m_bs_lawstandard law ON lawtype.SID = law.ID
where lawtype.LAWSTYPEID= #{id}
    </select>

    <!--获取历史法规-->
    <select id="getHistroyLaws" resultType="Lawstandard">
          SELECT t1.`CODE`,
        t1.id,t1.oldid FROM `m_bs_lawstandard` t1
    </select>

    <!--更新历史发布部门-->
    <update id="updatePublishByOldID" parameterType="Lawstandard">
        UPDATE m_bs_lawstandard_pubdep set SID = #{id} where sid = #{oldid}
    </update>

    <!--更新替代关系-->
    <update id="updateReplaceSidByOldID" parameterType="Lawstandard">
        UPDATE m_bs_lsreplacerelation set SID = #{id} where sid = #{oldid}
    </update>

    <!--更新替代关系-->
    <update id="updateReplacePidByOldID" parameterType="Lawstandard">
        UPDATE m_bs_lsreplacerelation set PID = #{id} where PID = #{oldid}
    </update>

    <!--更新录入人-->
    <update id="updateLawUser" parameterType="Lawstandard">
        UPDATE m_bs_lawstandard t set t.INPUTUSERID = #{inputuserid} where t.id=#{id}
    </update>

    <!--更新引用关系-->
    <update id="updateRefenceByOldID" parameterType="Lawstandard">
      UPDATE m_bs_lsrelatedrelation t set t.RelatedID = #{id} where t.RelatedID=#{oldid}
    </update>

    <!--更新索引-->
    <update id="updateLawsolr">
               INSERT INTO m_bs_solr (LAWSTANDARDID, SOLRTEXT) SELECT
	`m`.`id` AS LAWSTANDARDID,
	concat(
		`m`.`CODE`,
		';',
		`m`.`CHINESENAME`,
		';',
		`m`.`ENGLISHNAME`,
		';',
		`m`.`KEYWORDS`,
		';',
		`m`.`MEMO`,
		';',
		`m`.`SUMMARYINFO`,
		';',
		`m`.`STATUSNAME`,
		';',
		`m`.`PUBDEPNAME`,
		';',
		`m`.`TYPENAME`,
		';',

	IF (
		isnull(`m`.`filecontent`),
		'',
		`m`.`filecontent`
	)
	) AS SOLRTEXT
FROM
	(
		SELECT
			`t`.`ID` AS `id`,
			`t`.`CODE` AS `CODE`,
			`t`.`CHINESENAME` AS `CHINESENAME`,

		IF (
			isnull(`t`.`ENGLISHNAME`),
			'',
			`t`.`ENGLISHNAME`
		) AS `ENGLISHNAME`,

	IF (
		isnull(`t`.`KEYWORDS`),
		'',
		`t`.`KEYWORDS`
	) AS `KEYWORDS`,

IF (
	isnull(`t`.`MEMO`),
	'',
	`t`.`MEMO`
) AS `MEMO`,

IF (
	isnull(`t`.`SUMMARYINFO`),
	'',
	`t`.`SUMMARYINFO`
) AS `SUMMARYINFO`,

IF (
	isnull(`sta`.`STATUSNAME`),
	'',
	`sta`.`STATUSNAME`
) AS `STATUSNAME`,

IF (
	isnull(`dep`.`PUBDEPNAME`),
	'',
	`dep`.`PUBDEPNAME`
) AS `PUBDEPNAME`,
 `n`.`TYPENAME` AS `TYPENAME`,
 (
	SELECT
		group_concat(
			`file`.`CONTENT` SEPARATOR ','
		)
	FROM
		`m_sa_fileinfo` `file`
	WHERE
		`file`.`REFID` = `t`.`ID`
	GROUP BY
		`t`.`ID`
) AS `filecontent`
FROM
	`m_bs_lawstandard` `t`
LEFT JOIN `m_sa_lawstandardstatus` `sta` ON `t`.`STATUS` = `sta`.`ID`
LEFT JOIN `m_bs_lawstandard_pubdep` `pub` ON `t`.`ID` = `pub`.`SID`
LEFT JOIN `m_sa_publishdep` `dep` ON `dep`.`ID` = `pub`.`PUBDEPID`
LEFT JOIN m_bs_lawstandard_type `m` ON `m`.`SID` = `t`.`ID`
LEFT JOIN m_bs_lawstandardtype `n` ON `n`.`ID` = `m`.`LAWSTYPEID`
	) `m`
    </update>

    <!--获取临时法规-->
    <select id="getTempLaw" parameterType="String" resultType="Lawstandard">
        SELECT t.id FROM `m_bs_lawstandard` t where t.CHECKCODE =#{code} and t.APPROVESTATUS=4
    </select>

</mapper>