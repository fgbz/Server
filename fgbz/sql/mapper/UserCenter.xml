<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="phalaenopsis.fgbz.dao.UserCenterDao" >

    <!--新增或编辑新闻通知-->
    <insert id="SaveOrUpdateAdvice" parameterType="Adviceinfo">

        <selectKey keyProperty="count" resultType="int" order="BEFORE">
            select count(1) from m_bs_adviceinfo t where t.ID=#{id}
        </selectKey>

        <if test="count == 0">
            insert into m_bs_adviceinfo
            <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    ID,
                </if>
                <if test="title != null">
                    TITLE,
                </if>
                <if test="details != null">
                    DETAILS,
                </if>
                <if test="inputuserid != null">
                    INPUTUSERID,
                </if>
                    INPUTDATE,
                    MODIFYDATE,
            </trim>
            <trim prefix="values (" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    #{id,jdbcType=VARCHAR},
                </if>
                <if test="title != null">
                    #{title,jdbcType=VARCHAR},
                </if>
                <if test="details != null">
                    #{details,jdbcType=VARCHAR},
                </if>
                <if test="inputuserid != null">
                    #{inputuserid,jdbcType=VARCHAR},
                </if>
                now(),
                now(),
            </trim>

        </if>
        <if test="count>0">
            update  m_bs_adviceinfo set
            <trim prefix="" suffix="" suffixOverrides=",">

                <if test="title != null">
                    TITLE = #{title,jdbcType=VARCHAR},
                </if>
                <if test="details != null">
                    DETAILS = #{details,jdbcType=VARCHAR},
                </if>
                <if test="modifyuserid != null">
                    MODIFYUSERID = #{modifyuserid,jdbcType=VARCHAR},
                </if>


                MODIFYDATE= now(),
            </trim>
            where ID=#{id}


        </if>
    </insert>

    <!--删除通知-->
    <delete id="DeleteAdviceByID" parameterType="String">
        DELETE from m_bs_adviceinfo where id = #{id}
    </delete>

    <!--获取通知详情-->
    <select id="GetAdviceByID" parameterType="String" resultType="Adviceinfo">
        SELECT
	t.ID,
	t.TITLE,
	t.DETAILS,
	us.USERREALNAME as inputusername,
	org.ORGNAME,
	t.INPUTDATE
FROM
	m_bs_adviceinfo t
	LEFT JOIN m_sa_user us ON us.ID = t.INPUTUSERID
	LEFT JOIN m_sa_organization org ON us.ORGID = org.ID
	where t.ID = #{id}
    </select>

    <!--获取通知列表-->
    <select id="getAdviceList" parameterType="map" resultType="Adviceinfo">
             SELECT
	t.ID,
	t.TITLE,
	t.DETAILS,
     org.ORGNAME,
    t.INPUTDATE
FROM
	m_bs_adviceinfo t
        LEFT JOIN m_sa_user us ON us.ID = t.INPUTUSERID
        LEFT JOIN m_sa_organization org ON us.ORGID = org.ID
        WHERE 1=1
        <include refid="queryAdviceinfo"></include>
        ORDER by t.MODIFYDATE DESC
        LIMIT #{startRow},#{endRow}
    </select>

    <sql id="queryAdviceinfo">
        <if test="Title != null and Title != ''">
            and instr(t.TITLE,#{Title})> 0
        </if>
    </sql>

    <!--获取通知列表总数-->
    <select id="getAdviceListCount" parameterType="map" resultType="int">
        SELECT
      count(1)
        FROM
        m_bs_adviceinfo t WHERE 1=1
        <include refid="queryAdviceinfo"></include>
    </select>

    <!--保存留言-->
    <insert id="SaveOrUpdateSuggestion" parameterType="Suggestion">
        <selectKey keyProperty="count" resultType="int" order="BEFORE">
            select count(1) from m_bs_suggestion t where t.ID=#{id}
        </selectKey>

        <if test="count == 0">
            insert into m_bs_suggestion
            <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    ID,
                </if>
                <if test="title != null">
                    TITLE,
                </if>
                <if test="details != null">
                    DETAILS,
                </if>
                <if test="inputuserid != null">
                    INPUTUSERID,
                </if>
                INPUTDATE,
                MODIFYDATE,
            </trim>
            <trim prefix="values (" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    #{id,jdbcType=VARCHAR},
                </if>
                <if test="title != null">
                    #{title,jdbcType=VARCHAR},
                </if>
                <if test="details != null">
                    #{details,jdbcType=VARCHAR},
                </if>
                <if test="inputuserid != null">
                    #{inputuserid,jdbcType=VARCHAR},
                </if>
                now(),
                now(),
            </trim>

        </if>
        <if test="count>0">
            update  m_bs_suggestion set
            <trim prefix="" suffix="" suffixOverrides=",">

                <if test="title != null">
                    TITLE = #{title,jdbcType=VARCHAR},
                </if>
                <if test="details != null">
                    DETAILS = #{details,jdbcType=VARCHAR},
                </if>
                <if test="modifyuserid != null">
                    MODIFYUSERID = #{modifyuserid,jdbcType=VARCHAR},
                </if>


                MODIFYDATE= now(),
            </trim>
            where ID=#{id}


        </if>
    </insert>

    <!--删除留言-->
    <delete id="DeleteSuggestionByID" parameterType="String">
         DELETE from m_bs_suggestion where id = #{id}
    </delete>

    <!--获取留言列表-->
    <select id="getSuggestionList" resultType="Suggestion">
        SELECT
        t.ID,
        t.TITLE,
        t.DETAILS,
        org.ORGNAME,
        t.INPUTDATE,
        us.USERREALNAME as inputname
        FROM
        m_bs_suggestion t
        LEFT JOIN m_sa_user us ON us.ID = t.INPUTUSERID
        LEFT JOIN m_sa_organization org ON us.ORGID = org.ID
        WHERE 1=1
        <include refid="querySuggestion"></include>
        ORDER by t.MODIFYDATE DESC
        LIMIT #{startRow},#{endRow}
    </select>

    <sql id="querySuggestion">
        <if test="Title != null and Title != ''">
            and instr(t.TITLE,#{Title})> 0
        </if>
    </sql>

    <!--获取留言列表数量-->
    <select id="getSuggestionListCount" parameterType="map" resultType="int">
        SELECT
        count(1)
        FROM
        m_bs_suggestion t WHERE 1=1
        <include refid="querySuggestion"></include>
    </select>

    <!--保存审核信息-->
    <insert id="SaveApprove" parameterType="LawstandardApprove">
        insert into m_bs_lawstandard_approve
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                ID,
            </if>
            <if test="lawstandardID != null">
                LawstandardID,
            </if>
            <if test="content != null">
                Content,
            </if>
            <if test="approveUserID != null">
                ApproveUserID,
            </if>
            ApproveDate,
            <if test="status != null">
                Status,
            </if>

        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=VARCHAR},
            </if>
            <if test="lawstandardID != null">
                #{lawstandardID,jdbcType=VARCHAR},
            </if>
            <if test="content != null">
                #{content,jdbcType=VARCHAR},
            </if>
            <if test="approveUserID != null">
                #{approveUserID,jdbcType=VARCHAR},
            </if>
            now(),
            <if test="status != null">
                #{status,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>

    <!--通过法规id获取审核历史记录-->
    <select id="getApproveHistroy" parameterType="String" resultType="LawstandardApprove">
SELECT
	t.ID,
	t.LawstandardID,
	t.Content,
	t.ApproveUserID,
	t.ApproveDate,
	us.USERREALNAME as username,
	t.`Status`
FROM
	m_bs_lawstandard_approve t
LEFT JOIN m_sa_user us ON t.ApproveUserID = us.ID
where t.LawstandardID = #{id}
ORDER BY t.ApproveDate desc
    </select>

    <!--通过父节点id获取所有子记录-->
    <select id="getFavoriteListByID" parameterType="String" resultType="Favorite">
        SELECT t.id,t.`NAME` ,t.PARENTID from m_bs_favorite t where t.ID=#{id}
    </select>

    <!--通过父节点id获取所有子记录-->
    <select id="getFavoriteListByParentID" parameterType="String" resultType="Favorite">
        SELECT t.id,t.`NAME` ,t.PARENTID from m_bs_favorite t where t.PARENTID=#{id}
    </select>

    <!--删除收藏夹-->
    <delete id="DeleteFavoriteByID" parameterType="String" >
        DELETE FROM  m_bs_favorite where id= #{id}
    </delete>

    <!--删除收藏夹与法规的关联关系-->
    <delete id="DeleteFavoriteLawsLink" parameterType="map">
        DELETE FROM  m_bs_lawstandard_favorite where
        <if test="type == 'fav'.toString()">
            FAVORITEID= #{id}
        </if>
        <if test="type == 'law'.toString()">
            LAWSTANDRADID = #{id}
        </if>

    </delete>

    <!--建立法规与收藏夹关联-->
    <insert id="SaveFavoriteLawsLink" parameterType="map">
          INSERT into m_bs_lawstandard_favorite (id,FAVORITEID,LAWSTANDRADID)
          VALUES
        <foreach collection="fevlists" item="item" open="" close="" separator=",">
            (#{item.tableid},#{item.id},#{lawid})
        </foreach>
    </insert>

    <!--删除所有的收藏夹-->
    <delete id="DeleteAllFavorite" parameterType="list">
        DELETE from  m_bs_favorite where id in
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item.id}
        </foreach>
    </delete>

    <!--删除所有的收藏与法规关联关系-->
    <delete id="DeleteAllFavoriteLawsLink" parameterType="list">
        DELETE from  m_bs_lawstandard_favorite where FAVORITEID in
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item.id}
        </foreach>
    </delete>

    <!--新增或编辑收藏夹-->
    <insert id="SaveOrUpdateFavorite" parameterType="Favorite">

        <selectKey keyProperty="count" resultType="int" order="BEFORE">
            select count(1) from m_bs_favorite t where t.ID=#{id}
        </selectKey>

        <if test="count == 0">
            insert into m_bs_favorite
            <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    ID,
                </if>
                <if test="name != null">
                    NAME,
                </if>
                <if test="parentid != null">
                    PARENTID,
                </if>
                <if test="inputuserid != null">
                    INPUTUSERID,
                </if>
                INPUTDATE,
                MODIFYDATE,
            </trim>
            <trim prefix="values (" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    #{id,jdbcType=VARCHAR},
                </if>
                <if test="name != null">
                    #{name,jdbcType=VARCHAR},
                </if>
                <if test="parentid != null">
                    #{parentid,jdbcType=VARCHAR},
                </if>
                <if test="inputuserid != null">
                    #{inputuserid,jdbcType=VARCHAR},
                </if>
                now(),
                now(),
            </trim>

        </if>
        <if test="count>0">
            update  m_bs_favorite set
            <trim prefix="" suffix="" suffixOverrides=",">

                <if test="name != null">
                    name = #{name,jdbcType=VARCHAR},
                </if>
                <if test="modifyuserid != null">
                    MODIFYUSERID = #{modifyuserid,jdbcType=VARCHAR},
                </if>


                MODIFYDATE= now(),
            </trim>
            where ID=#{id}


        </if>
    </insert>

    <!--获取收藏夹关联的法规-->
    <select id="getLawsByLinkID" parameterType="map" resultType="Lawstandard">
SELECT
	t.ID,
	t.CHINESENAME,
	fav.INPUTDATE,
    fav.name as favname,
    fav.id as favid
FROM
	m_bs_lawstandard t
LEFT JOIN m_bs_lawstandard_favorite link ON t.ID = link.LAWSTANDRADID
LEFT JOIN m_bs_favorite fav ON link.FAVORITEID = fav.ID
WHERE
	fav.id IN
        <foreach collection="TreeValue" item="item" open="(" close=")" separator=",">
            #{item.id}
        </foreach>

        order by fav.INPUTDATE DESC
        LIMIT #{startRow},#{endRow}
    </select>

    <select id="getLawsByLinkIDCount" parameterType="map" resultType="int">
        select count(1) from m_bs_lawstandard t
        LEFT JOIN m_bs_lawstandard_favorite link ON t.ID = link.LAWSTANDRADID
        LEFT JOIN m_bs_favorite fav ON link.FAVORITEID = fav.ID
        WHERE
        fav.id IN
        <foreach collection="TreeValue" item="item" open="(" close=")" separator=",">
            #{item.id}
        </foreach>
    </select>

    <!--获取法规对应的收藏夹Favorite-->
    <select id="getFavoriteListByLawID" parameterType="String" resultType="Favorite">
        SELECT
	t.ID
FROM
	m_bs_favorite t
LEFT JOIN m_bs_lawstandard_favorite link ON t.ID = link.FAVORITEID

where link.LAWSTANDRADID=#{id}
    </select>

    <!--取消收藏-->
    <delete id="DismissFavorite" parameterType="map" >
        delete from m_bs_lawstandard_favorite where FAVORITEID =#{favid} and LAWSTANDRADID =#{lawid}
    </delete>

    <!--通过密码和用户id查看用户-->
    <select id="getUserByPasswordAndId" parameterType="map" resultType="int">
        SELECT count(1) from m_sa_user t where t.id=#{id} and t.PASSWORD = #{oldpassword}
    </select>

    <!--更新用户密码-->
    <update id="updateUserPassword" parameterType="map">
        update m_sa_user set PASSWORD=#{newpassword} where id=#{id}
    </update>

</mapper>