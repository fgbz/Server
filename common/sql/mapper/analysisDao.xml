<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper  
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="analysisMapper">

	<resultMap type="AnalysisLayerGroup" id="analysisLayerGroupMap">
	         <id property="Id" column="ID"/>
	         <result property="BusinessType" column="BUSINESSTYPE"/>
	         <result property="TerminalType" column="TERMINALTYPE"/>
	         <result property="DisplayType" column="DISPLAYTYPE"/>
	         <result property="GeometryServer" column="GEOMETRYSERVER"/>
	         <collection property="Layers" ofType="AnalysisLayer">   
	         	<result property="Id" column="LAYERID"/>
	            <result property="Alias" column="ALIAS"/>
	            <result property="Star" column="STAR"/>
	            <result property="Mode" column="ANALYSISMODE"/>
	            <result property="Name" column="LAYERNAME"/>
	            <result property="Url" column="URL"/>
	            <result property="MappingUrl" column="MAPPINGURL"/>    
	            <result property="LayerIndex" column="LAYERINDEX"/>
	            <result property="IsNeedUnion" column="ISNEEDUNION"/>    
	            <result property="SortOrder" column="SORTORDER"/>
	            <result property="Type" column="LAYERTYPE"/>
	            <collection property="FieldCollection"  ofType="Field">
	                    <id property="Id" column="FIELDID" />     
			            <result property="Alias" column="ALIAS2"/>
			            <result property="CombinMode" column="COMBINMODE"/>
			            <result property="IsMaxDisplayColumn" column="ISMAXDISPLAYCOLUMN"/>
			            <result property="Name" column="NAME"/>
			            <result property="IsUnionKey" column="ISUNIONKEY"/>
	            </collection>
            </collection>  
	</resultMap>

    <!-- 根据业务类型和终端类型，获取需要分析的图层集合 -->
	<select id="queryAnalysisLayerGroup" resultMap="analysisLayerGroupMap" parameterType="java.util.Map">
	      select t1.ID as id,t1.BUSINESSTYPE,t1.TERMINALTYPE,t1.GEOMETRYSERVER,t1.DISPLAYTYPE,
	      t2.ID as layerId,t2.ALIAS,t2.STAR,t2.ANALYSISMODE,t2.LAYERNAME,t2.URL,t2.MAPPINGURL,
	      t2.LAYERINDEX,t2.ISNEEDUNION,t2.SORTORDER,t2.LAYERTYPE,
	      t3.ID as fieldId,t3.NAME,t3.ALIAS as ALIAS2,t3.ISUNIONKEY,t3.COMBINMODE,t3.ISMAXDISPLAYCOLUMN
	      from AN_ANALYSISLAYERGROUP t1,AN_ANALYSISLAYER t2,AN_FIELD t3
	     <where>
	        and t1.ID=t2.ANALYSISLAYERGROUP_ID and t2.ID=t3.ANALYSISLAYER_ID
	        <if test="businessType!=null and businessType!=''">
	        and  BUSINESSTYPE=#{businessType}
	        </if>
	        <if test="terminalType!=null and terminalType!=''">
	        and  TERMINALTYPE=#{terminalType}
	        </if>
	        <if test="displayType!=null and displayType!=''">
	        and  DISPLAYTYPE=#{displayType}
	        </if>
	     </where>
	     order by t2.SORTORDER ASC
	</select>
	
	<!-- 获取图斑分析结果 -->
	<select id="getAnalysisResult" resultType="SpotAnalysisResult" parameterType="java.util.Map">
	   select  t.ID as id,t.RESULT as result,t.BUSINESSID as businessID,t.SOURCE as source from   AN_ANALYSISRESULT t 
	   where t.businessID=#{id} and t.SOURCE=#{source}
	
	</select>
	<!-- 保存图斑分析结果 -->
	<insert id="saveAnalysisResult" parameterType="SpotAnalysisResult">
		<selectKey keyProperty="count" resultType="int" order="BEFORE">
			select count(1) from AN_ANALYSISRESULT t where t.id=#{id}
		</selectKey>
		<if test="count==0">
			insert into  AN_ANALYSISRESULT
			(
			    ID,
			    RESULT,
			    BUSINESSID,
			    SOURCE,
			    TIMING
			)
			values
			(
			    #{id},
			    #{result},
			    #{businessID},
			    #{source},
			    #{timing}
			)
		</if>
		<if test="count>0">
			update AN_ANALYSISRESULT t
			      set timing=#{timing},RESULT=#{result} where t.id=#{id}
		</if>
	</insert>
	
	<!-- 删除图斑分析结果 -->
	<delete id="deleteAnalysisResult" parameterType="long">
		delete from AN_ANALYSISRESULT where BUSINESSID=#{id}
	</delete>
</mapper>