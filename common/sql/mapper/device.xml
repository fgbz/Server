<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="device">
  <!-- 获取设备总数量-->
  <select id="getDevicesCount" parameterType="map" resultType="int">
		select count(*) from sys_device d
		<if test="Org!=null and Org !=''">
		 	inner join
			(select t.id, t.name from sys_Organization t start with id = #{Org} connect by prior id = parentid) o on d.ORGANIZATIONID = o.id
		</if>
		<if test="Org==null or Org ==''">
			inner join sys_Organization o on o.id = d.organizationid 
		</if>
		<if test="SearchText!=null and SearchText !=''">
			where d.name like '%'||#{SearchText}||'%'
			or d.phone like '%'||#{SearchText}||'%'
		</if>
	</select>
	
	<!-- 分页获取设备列表 -->
	<select id="getDevices" parameterType="map" resultType="phalaenopsis.common.entity.Device">
		select * from (
		select d.id, d.name, d.phone, d.organizationid, o.name as OrganizationName ,rownum as rn from sys_device d
		<if test="Org!=null and Org !=''">
		 	inner join
			(select t.id, t.name from sys_Organization t start with id = #{Org} connect by prior id = parentid) o on d.ORGANIZATIONID = o.id
		</if>
		<if test="Org==null or Org ==''">
			inner join sys_Organization o on o.id = d.organizationid 
		</if>
		<if test="SearchText!=null and SearchText !=''">
			where d.name like '%'||#{SearchText}||'%'
			or d.phone like '%'||#{SearchText}||'%'
		</if>
		) where rn between #{startNum}  and  #{endNum}
	</select>
	
	<!-- 获取设备信息 -->
	<select id="getDevice" parameterType="String" resultType="phalaenopsis.common.entity.Device">
		select * from sys_device where id=#{ID}
	</select>
	
	<!-- 判断设备名称是否存在 -->
	<select id="queryByName" parameterType="String" resultType="int">
		select count(*) from sys_device where name=#{deviceName}
	</select>
	
	<!-- 判断修改时设备名称是否与其他设备名称重复 -->
	<select id="isHaveName" parameterType="phalaenopsis.common.entity.Device" resultType="int">
		select count(*) from sys_device where name=#{Name} and id!=#{ID}
	</select>
	
	<!-- 添加设备 -->
	<insert id="addDevice" parameterType="phalaenopsis.common.entity.Device">
		insert into sys_device (id,name,phone,organizationid)
		values(#{ID},#{Name},#{Phone},#{OrganizationID})
	</insert>

	<!-- 更新设备 -->
	<update id="updateDevice" parameterType="phalaenopsis.common.entity.Device">
		update sys_device set
		name=#{Name},phone=#{Phone},organizationid=#{OrganizationID} where
		id=#{ID}
	</update>

	<!-- 批量删除设备 -->
	<delete id="deleteDevices" parameterType="java.util.List">
		delete from sys_device where id in
		<foreach collection="list" item="item" index="index" open="("
			separator="," close=")">
			#{item}
		</foreach> 
	</delete>

</mapper>