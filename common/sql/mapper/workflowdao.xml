<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="phalaenopsis.common.dao.IWorkFlowDao">

	<!-- 添加或更新流程实例的数据 -->
    <insert id="saveOrUpdateWFInstance" parameterType="phalaenopsis.workflowEngine.storage.WFInstance">
    	<selectKey keyProperty="count"  resultType="int" order="BEFORE">
    		 select count(*) from WF_Instance where INSTANCEID = #{InstanceID}
    	</selectKey>
    	<if test="count > 0">
    		update WF_Instance set MAPID =#{MapID}, NodeID=#{NodeID}, State= #{State},
    	    SequencePtr=#{SequencePtr,jdbcType=INTEGER}, Route=#{Route,jdbcType=VARCHAR},version=#{version,jdbcType=INTEGER}
    		where InstanceID=#{InstanceID}
    	</if>
    	<if test="count == 0">
    		insert into WF_Instance(InstanceID, MAPID, NodeID, State, SequencePtr, Route,version)
    		values(#{InstanceID}, #{MapID}, #{NodeID}, #{State}, #{SequencePtr,jdbcType=INTEGER}, 
    		#{Route,jdbcType=VARCHAR},#{version,jdbcType=INTEGER})
    	</if>
    </insert>
    
    <!-- 保存历史记录 -->
    <insert id="saveWFHistory" parameterType="phalaenopsis.workflowEngine.storage.WFHistory">
    	insert into WF_History(ID, InstanceID, NodeID, Sequence)
    	values(#{ID}, #{InstanceID}, #{NodeID}, #{Sequence})
    </insert>
    
    <!-- 获取流程实例数据 -->
    <select id="getInstance" parameterType="string" resultType="phalaenopsis.workflowEngine.storage.WFInstance">
    	select InstanceID, MAPID, NodeID, State, SequencePtr, Route, version from WF_Instance where InstanceID =#{InstanceID,jdbcType=VARCHAR}
    </select>
    
    <!-- 获取流程历史记录 -->
    <select id="getHistories" parameterType="string" resultType="phalaenopsis.workflowEngine.storage.WFHistory">
    	select ID, InstanceID, NodeID, Sequence from WF_History 
    	 where InstanceID = #{instanceID,jdbcType=VARCHAR} order by Sequence
    </select>
    
    
       <!-- 删除流程实例数据 -->
    <delete id="deleteInstance" parameterType="string">
    	delete WF_INSTANCE where instanceid=#{instanceID}
    </delete>
    
    <!-- 删除一条流程中的所有节点 -->
    <delete id="deleteHistory" parameterType="string">
    	delete WF_HISTORY where instanceid=#{instanceID} 
    </delete>
    
    
    <!-- 删除最好一条流程数据 -->
    <delete id="deleteLastHistory" parameterType="phalaenopsis.workflowEngine.storage.WFHistory">
    	delete WF_HISTORY  where instanceid = #{InstanceID} and sequence = #{Sequence}
    </delete>
    

</mapper>